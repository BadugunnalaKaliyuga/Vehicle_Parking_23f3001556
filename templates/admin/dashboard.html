{% extends 'base.html' %}
{% block content %}
<div class="d-flex flex-wrap gap-4">
    {% for lot in lots %}
    <div class="card" style="min-width: 300px; max-width: 350px;">
        <div class="card-header bg-primary text-white">
            <strong>{{ lot.prime_location_name }}</strong>
            <span class="float-end">
                <a href="#" class="text-warning me-2 edit-lot-btn" data-lot='{{ {"id": lot.id, "prime_location_name": lot.prime_location_name, "address": lot.address, "pin_code": lot.pin_code, "price": lot.price} | tojson }}'>Edit</a>
                <a href="#" class="text-danger delete-lot-btn" data-lot-id="{{ lot.id }}">delete</a>
            </span>
        </div>
        <div class="card-body">
            <p><strong>Address:</strong> {{ lot.address }}</p>
            <p><strong>pin:</strong> {{ lot.pin_code }}</p>
            <p><strong>price/hr:</strong> {{ lot.price }}</p>
            <p><strong>occupied:</strong> {{ lot.spots|selectattr('status', 'equalto', 'O')|list|length }}/{{ lot.spots|length }}</p>
            <div class="d-flex flex-wrap gap-1">
                {% for spot in lot.spots %}
                <span class="badge rounded-pill spot-badge {% if spot.status == 'A' %}bg-success{% else %}bg-danger{% endif %}" data-spot-id="{{ spot.id }}" data-status="{{ spot.status }}" style="cursor:pointer;">{{ spot.status }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
    <div class="card d-flex align-items-center justify-content-center" style="min-width: 300px; max-width: 350px;">
        <div class="card-body text-center">
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addLotModal">+ Add Lot</button>
        </div>
    </div>
</div>
<div class="modal fade" id="addLotModal" tabindex="-1" aria-labelledby="addLotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
    <div class="modal-content">
        <form id="addLotForm">
        <div class="modal-header">
            <h5 class="modal-title" id="addLotModalLabel">Add Parking Lot</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3"><label class="form-label">Prime Location Name</label><input type="text" class="form-control" name="prime_location_name" required></div>
            <div class="mb-3"><label class="form-label">Address</label><input type="text" class="form-control" name="address" required></div>
            <div class="mb-3"><label class="form-label">Pin Code</label><input type="text" class="form-control" name="pin_code" required></div>
            <div class="mb-3"><label class="form-label">Price (per hour)</label><input type="number" class="form-control" name="price" required></div>
            <div class="mb-3"><label class="form-label">Maximum Spots</label><input type="number" class="form-control" name="maximum_number_of_spots" required></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add</button>
        </div>
        </form>
    </div>
</div>
</div>
<div class="modal fade" id="editLotModal" tabindex="-1" aria-labelledby="editLotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editLotForm">
        <div class="modal-header">
            <h5 class="modal-title" id="editLotModalLabel">Edit Parking Lot</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" name="lot_id" id="edit_lot_id">
            <div class="mb-3"><label class="form-label">Prime Location Name</label><input type="text" class="form-control" name="prime_location_name" id="edit_prime_location_name" required></div>
            <div class="mb-3"><label class="form-label">Address</label><input type="text" class="form-control" name="address" id="edit_address" required></div>
            <div class="mb-3"><label class="form-label">Pin Code</label><input type="text" class="form-control" name="pin_code" id="edit_pin_code" required></div>
            <div class="mb-3"><label class="form-label">Price (per hour)</label><input type="number" class="form-control" name="price" id="edit_price" required></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update</button>
        </div>
        </form>
    </div>
    </div>
</div>
<div class="modal fade" id="deleteLotModal" tabindex="-1" aria-labelledby="deleteLotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
    <div class="modal-content">
        <form id="deleteLotForm">
        <div class="modal-header">
            <h5 class="modal-title" id="deleteLotModalLabel">Delete Parking Lot</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" name="lot_id" id="delete_lot_id">
            <p>Are you sure you want to delete this parking lot?</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Delete</button>
        </div>
        </form>
    </div>
</div>
</div>
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
    <div class="modal-content">
        <form id="editProfileForm">
        <div class="modal-header">
            <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3"><label class="form-label">Username</label><input type="text" class="form-control" name="new_username" id="editProfileUsername" required></div>
            <div class="mb-3"><label class="form-label">New Password</label><input type="password" class="form-control" name="new_password"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update</button>
        </div>
        </form>
    </div>
</div>
</div>
<div class="modal fade" id="spotInfoModal" tabindex="-1" aria-labelledby="spotInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header bg-warning-subtle">
        <h5 class="modal-title" id="spotInfoModalLabel">View/Delete Parking Spot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
            <div class="modal-body">
            <div class="mb-2"><strong>ID:</strong> <span id="spotInfoId"></span></div>
            <div class="mb-2"><strong>Status:</strong> <span id="spotInfoStatus" style="cursor:pointer;"></span></div>
            <div id="spotInfoFields"></div>
        </div>
        <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="deleteSpotBtn">Delete</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
    </div>
</div>
</div>
<div class="modal fade" id="occupiedDetailsModal" tabindex="-1" aria-labelledby="occupiedDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
    <div class="modal-content">
    <div class="modal-header bg-warning-subtle">
        <h5 class="modal-title" id="occupiedDetailsModalLabel">Occupied Parking Spot Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
    <div class="modal-body">
        <div class="mb-2"><strong>ID:</strong> <span id="occSpotId"></span></div>
        <div class="mb-2"><strong>Customer ID:</strong> <span id="occUserId"></span></div>
        <div class="mb-2"><strong>Vehicle number:</strong> <span id="occVehicle"></span></div>
        <div class="mb-2"><strong>Date/time of parking:</strong> <span id="occTime"></span></div>
        <div class="mb-2"><strong>Est. parking cost:</strong> <span id="occCost"></span></div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    </div>
    </div>
</div>
</div>
<div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
    <div class="modal-content">
        <div class="modal-header">
        <h5 class="modal-title" id="summaryModalLabel">Parking Lot Summary</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-6">
            <h6 class="text-center">Revenue from each parking lot</h6>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
            </div>
        <div class="col-md-6">
            <h6 class="text-center">Available vs. Occupied Spots</h6>
            <div class="chart-container">
                <canvas id="spotChart"></canvas>
            </div>
            </div>
        </div>
        </div>
    </div>
    </div>
</div>
<style>
.chart-container {
    position: relative;
    width: 100%;
    height: 40vh;
    margin: auto;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    var summaryLink = document.getElementById('summary-link');
    if (summaryLink) {
    summaryLink.onclick = function(e) {
        e.preventDefault();
        const lotNames = {{ lot_names|tojson }};
        const revenues = {{ revenues|tojson }};
        const availableCounts = {{ available_counts|tojson }};
        const occupiedCounts = {{ occupied_counts|tojson }};
    
        const lotLabelsWithRevenue = lotNames.map((name, i) => `${name} ($${Number(revenues[i]).toFixed(2)})`);
        var modal = new bootstrap.Modal(document.getElementById('summaryModal'));
        setTimeout(function() {
        new Chart(document.getElementById('revenueChart'), {
            type: 'doughnut',
            data: {
                labels: lotLabelsWithRevenue,
                datasets: [{
                    label: 'Revenue',
                    data: revenues,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                    callbacks: {
                        label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed;
                        return `${label}: $${Number(value).toFixed(2)}`;
                        }
                    }
                    }
                }
            }
        });
        new Chart(document.getElementById('spotChart'), {
            type: 'bar',
            data: {
                labels: lotNames,
                datasets: [
                    {
                        label: 'Available',
                        data: availableCounts,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                    },
                    {
                        label: 'Occupied',
                        data: occupiedCounts,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: { legend: { position: 'top' } }
            }
        });
        }, 200);
        modal.show();
    };
}

document.getElementById('addLotForm').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    fetch('/admin/add_lot', {
    method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
        prime_location_name: form.prime_location_name.value,
        address: form.address.value,
        pin_code: form.pin_code.value,
        price: form.price.value,
        maximum_number_of_spots: form.maximum_number_of_spots.value
        })
    }).then(r => r.json()).then(res => {
        if (res.success) {
        location.reload();
        } else {
        alert(res.message || 'error adding ');
        }
    });
};


const editButtons = document.querySelectorAll('.edit-lot-btn');
editButtons.forEach(btn => {
    btn.onclick = function() {
        const lot = JSON.parse(this.dataset.lot);
        document.getElementById('edit_lot_id').value = lot.id;
        document.getElementById('edit_prime_location_name').value = lot.prime_location_name;
        document.getElementById('edit_address').value = lot.address;
        document.getElementById('edit_pin_code').value = lot.pin_code;
        document.getElementById('edit_price').value = lot.price;
        new bootstrap.Modal(document.getElementById('editLotModal')).show();
    };
});


const deleteButtons = document.querySelectorAll('.delete-lot-btn');
deleteButtons.forEach(btn => {
    btn.onclick = function() {
    document.getElementById('delete_lot_id').value = this.dataset.lotId;
    new bootstrap.Modal(document.getElementById('deleteLotModal')).show();
    };
});
if (document.getElementById('deleteLotForm')) {
    document.getElementById('deleteLotForm').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    fetch('/admin/delete_lot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lot_id: form.lot_id.value })
    }).then(r => r.json()).then(res => {
        if (res.success) {
            location.reload();
        } else {
            alert(res.message || 'error in deleting lot');
        }
    });
    };
}


if (document.getElementById('editLotForm')) {
    document.getElementById('editLotForm').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    fetch('/admin/edit_lot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            lot_id: form.lot_id.value,
            prime_location_name: form.prime_location_name.value,
            address: form.address.value,
            pin_code: form.pin_code.value,
            price: form.price.value
        })
        }).then(r => r.json()).then(res => {
        if (res.success) {
            location.reload();
        } else {
            alert(res.message || 'error updation lot');
        }
    });
    };
}

var editProfileLink = document.getElementById('edit-profile-link');
    if (editProfileLink) {
    editProfileLink.onclick = function(e) {
        e.preventDefault();
        fetch('/admin/profile_info').then(r => r.json()).then(data => {
        document.getElementById('editProfileUsername').value = data.username;
        new bootstrap.Modal(document.getElementById('editProfileModal')).show();
    });
    };
    }
if (document.getElementById('editProfileForm')) {
    document.getElementById('editProfileForm').onsubmit = function(e) {
        e.preventDefault();
        const form = e.target;
        fetch('/admin/edit_profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            new_username: form.new_username.value,
            new_password: form.new_password.value
        })
    }).then(r => r.json()).then(res => {
        if (res.success) {
            const msg = document.createElement('div');
            msg.className = 'alert alert-success';
            msg.textContent = 'Profile updated!';
            form.prepend(msg);
            setTimeout(() => {
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
            msg.remove();
        }, 1200);
        } else {
        alert(res.message || 'error ');
        }
    });
    };
}


document.querySelectorAll('.spot-badge').forEach(function(badge) {
    badge.onclick = function() {
        const spotId = this.dataset.spotId;
        fetch(`/admin/spot_details/${spotId}`).then(r => r.json()).then(data => {
        document.getElementById('spotInfoId').textContent = data.id;
        document.getElementById('spotInfoStatus').textContent = data.status;
        document.getElementById('spotInfoStatus').className = data.status === 'A' ? 'badge bg-success' : 'badge bg-danger';
        document.getElementById('spotInfoFields').innerHTML = '';
        document.getElementById('deleteSpotBtn').disabled = (data.status !== 'A');
        document.getElementById('deleteSpotBtn').setAttribute('data-spot-id', data.id);
        if (data.status === 'O') {
            document.getElementById('spotInfoStatus').style.cursor = 'pointer';
            document.getElementById('spotInfoStatus').onclick = function() {
            fetch(`/admin/occupied_details/${spotId}`).then(r => r.json()).then(res => {
                if (res.error) {
                alert(res.error);
                return;
                }
                document.getElementById('occSpotId').textContent = res.spot_id;
                document.getElementById('occUserId').textContent = res.user_id;
                document.getElementById('occVehicle').textContent = res.vehicle_number;
                document.getElementById('occTime').textContent = res.parking_time;
                document.getElementById('occCost').textContent = res.parking_cost;
                new bootstrap.Modal(document.getElementById('occupiedDetailsModal')).show();
            });
        };
        } else {
            document.getElementById('spotInfoStatus').style.cursor = 'default';
            document.getElementById('spotInfoStatus').onclick = null;
        }
        new bootstrap.Modal(document.getElementById('spotInfoModal')).show();
    });
    };
});
    document.getElementById('deleteSpotBtn').onclick = function() {
    const spotId = this.getAttribute('data-spot-id');
    if (!spotId) return;
    fetch('/admin/delete_spot', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spot_id: spotId })
    }).then(r => r.json()).then(res => {
        if (res.success) {
            location.reload();
        } else {
            alert(res.message || 'cannot delete occupied stop');
        }
        });
    };
});
</script>
{% endblock %} 
